<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GTA RP Interactive Map</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }

    .panel {
      position: absolute;
      top: 12px;
      left: 12px;
      z-index: 9999;
      background: white;
      padding: 12px;
      border-radius: 10px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.18);
      font-family: Arial, sans-serif;
      width: 320px;
      max-height: calc(100% - 24px);
      overflow: auto;
    }
    .panel h2 { margin: 0 0 10px; font-size: 16px; }
    .row { margin: 8px 0; }
    .row small { color: #555; }
    button {
      cursor: pointer;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #ddd;
      background: #f7f7f7;
      font-weight: 600;
      width: 100%;
      margin-top: 6px;
    }
    button:hover { background: #efefef; }
    .btnrow { display: flex; gap: 8px; }
    .btnrow button { width: 50%; }
    .chips { display: flex; flex-wrap: wrap; gap: 6px; }
    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px solid #ddd;
      padding: 6px 8px;
      border-radius: 999px;
      font-size: 13px;
      user-select: none;
    }
    .chip input { margin: 0; }
    .muted { color: #666; font-size: 12px; line-height: 1.4; }
    .divider { height: 1px; background: #eee; margin: 10px 0; }
    .danger { color: #b00020; font-weight: 700; }
    input[type="file"] { width: 100%; }
    .count { font-weight: 700; }

    /* Modal */
    .modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.25);
      z-index: 10000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    .modal {
      background: white;
      width: min(520px, 100%);
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
      padding: 14px;
      font-family: Arial, sans-serif;
    }
    .modal h3 { margin: 0 0 10px; font-size: 16px; }
    .modal label { display: block; font-size: 13px; margin: 8px 0 4px; }
    .modal input, .modal textarea {
      width: 100%;
      box-sizing: border-box;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 8px;
      font-size: 14px;
    }
    .modal textarea { min-height: 90px; resize: vertical; }
    .modal .btnrow button { margin-top: 10px; }
    .coords {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      color: #444;
      background: #f5f5f5;
      border-radius: 8px;
      padding: 6px 8px;
      display: inline-block;
      margin-top: 6px;
    }

    /* Error banner */
    .error-banner {
      position: absolute;
      top: 12px;
      right: 12px;
      z-index: 20000;
      background: #b00020;
      color: white;
      padding: 10px 12px;
      border-radius: 10px;
      font-family: Arial, sans-serif;
      max-width: 380px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.25);
      display: none;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="error-banner" id="errorBanner"></div>

  <div class="panel">
    <h2>GTA RP Map</h2>

    <div class="row muted">
      Click anywhere on the map to add a pin. Use categories to filter.
    </div>

    <div class="divider"></div>

    <div class="row">
      <div><strong>Pins loaded:</strong> <span class="count" id="pinCount">0</span></div>
      <div class="muted">Pins come from <code>pins.json</code> plus any unsaved local edits.</div>
    </div>

    <div class="row">
      <strong>Category Filters</strong>
      <div class="chips" id="categoryChips"></div>
      <div class="muted">Uncheck to hide a category.</div>
    </div>

    <div class="divider"></div>

    <div class="row">
      <strong>Save / Share</strong>
      <div class="muted">
        GitHub Pages can’t auto-save to the server. Use <b>Export</b> to download an updated <code>pins.json</code>,
        then upload/commit it to GitHub so everyone sees it.
      </div>
      <button id="exportBtn">Export pins.json (download)</button>

      <div class="row">
        <small><b>Import pins.json</b> (merge or replace):</small>
        <input type="file" id="importFile" accept=".json,application/json" />
        <div class="btnrow">
          <button id="importMergeBtn">Import (merge)</button>
          <button id="importReplaceBtn" class="danger">Import (replace)</button>
        </div>
      </div>

      <button id="clearLocalBtn" class="danger">Clear local unsaved edits</button>
    </div>

    <div class="divider"></div>

    <div class="row muted">
      <b>Setup note:</b> Your map image pixel size is set below:
      <br/>Width: <code>6144</code>, Height: <code>9216</code>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal">
      <h3>Add Pin</h3>
      <div class="muted">Fill this out and click “Add Pin”.</div>
      <div class="coords" id="coordDisplay"></div>

      <label>Title</label>
      <input id="pinTitle" placeholder="e.g., Sandy Shores Hospital" />

      <label>Category</label>
      <input id="pinCategory" placeholder="e.g., EMS / PD / Shops / Gangs" list="categoryList" />
      <datalist id="categoryList"></datalist>

      <label>Notes</label>
      <textarea id="pinNotes" placeholder="Anything your crew should know…"></textarea>

      <div class="btnrow">
        <button id="cancelPinBtn">Cancel</button>
        <button id="addPinBtn">Add Pin</button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // ---- CONFIG ----
    const IMAGE_WIDTH  = 6144; // width in pixels
    const IMAGE_HEIGHT = 9216; // height in pixels
    const MAP_IMAGE_FILENAME = "map.jpg";
    const PINS_FILENAME = "pins.json";
    const LOCAL_STORAGE_KEY = "gta_rp_map_local_pins_v1";

    // ---- ERROR UI ----
    const errorBanner = document.getElementById("errorBanner");
    function showError(msg) {
      console.error(msg);
      errorBanner.textContent = msg;
      errorBanner.style.display = "block";
    }

    // ---- Basic resource checks (helps debug 404s) ----
    async function verifyResource(url) {
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`Failed to load ${url} (HTTP ${res.status})`);
      return res;
    }

    // ---- LEAFLET MAP INIT ----
    const map = L.map("map", { crs: L.CRS.Simple, minZoom: -2, maxZoom: 4 });

    // Bounds must be [[y1,x1],[y2,x2]] = [[top,left],[bottom,right]]
    const bounds = [[0, 0], [IMAGE_HEIGHT, IMAGE_WIDTH]];

    // ---- App State ----
    let pins = [];
    let basePins = [];
    let localPins = [];
    let markers = [];
    let categoryVisibility = new Map();
    let pendingLatLng = null;

    // ---- UI Elements ----
    const pinCountEl = document.getElementById("pinCount");
    const categoryChipsEl = document.getElementById("categoryChips");
    const exportBtn = document.getElementById("exportBtn");
    const importFile = document.getElementById("importFile");
    const importMergeBtn = document.getElementById("importMergeBtn");
    const importReplaceBtn = document.getElementById("importReplaceBtn");
    const clearLocalBtn = document.getElementById("clearLocalBtn");

    const modalBackdrop = document.getElementById("modalBackdrop");
    const coordDisplay = document.getElementById("coordDisplay");
    const pinTitle = document.getElementById("pinTitle");
    const pinCategory = document.getElementById("pinCategory");
    const pinNotes = document.getElementById("pinNotes");
    const addPinBtn = document.getElementById("addPinBtn");
    const cancelPinBtn = document.getElementById("cancelPinBtn");
    const categoryList = document.getElementById("categoryList");

    function esc(s) {
      return (s ?? "").toString().replace(/</g,"&lt;").replace(/>/g,"&gt;");
    }

    function normalizePin(p) {
      if (!p) return null;
      const name = (p.name ?? "").toString().trim() || "Untitled";
      const category = (p.category ?? "Uncategorized").toString().trim() || "Uncategorized";
      const note = (p.note ?? "").toString();
      const x = Number(p.x);
      const y = Number(p.y);
      if (!Number.isFinite(x) || !Number.isFinite(y)) return null;
      return { name, category, note, x, y };
    }

    function loadLocalPins() {
      try {
        const raw = localStorage.getItem(LOCAL_STORAGE_KEY);
        localPins = raw ? JSON.parse(raw) : [];
        if (!Array.isArray(localPins)) localPins = [];
      } catch {
        localPins = [];
      }
    }

    function saveLocalPins() {
      localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(localPins));
    }

    async function loadBasePins() {
      try {
        const res = await fetch(PINS_FILENAME, { cache: "no-store" });
        const data = await res.json();
        basePins = Array.isArray(data) ? data : [];
      } catch {
        basePins = [];
      }
    }

    function combinedPins() {
      return [...basePins, ...localPins].map(normalizePin).filter(Boolean);
    }

    function rebuildCategoryUI() {
      const cats = [...new Set(pins.map(p => p.category))].sort((a,b)=>a.localeCompare(b));
      categoryChipsEl.innerHTML = "";
      categoryList.innerHTML = "";

      cats.forEach(cat => {
        if (!categoryVisibility.has(cat)) categoryVisibility.set(cat, true);

        const label = document.createElement("label");
        label.className = "chip";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = !!categoryVisibility.get(cat);
        cb.addEventListener("change", () => {
          categoryVisibility.set(cat, cb.checked);
          renderPins();
        });

        const span = document.createElement("span");
        span.textContent = cat;

        label.appendChild(cb);
        label.appendChild(span);
        categoryChipsEl.appendChild(label);

        const opt = document.createElement("option");
        opt.value = cat;
        categoryList.appendChild(opt);
      });
    }

    function clearMarkers() {
      markers.forEach(m => map.removeLayer(m));
      markers = [];
    }

    function renderPins() {
      clearMarkers();
      const visiblePins = pins.filter(p => categoryVisibility.get(p.category) !== false);

      visiblePins.forEach(p => {
        const marker = L.marker([p.y, p.x]).addTo(map);
        marker.bindPopup(
          `<strong>${esc(p.name)}</strong><br>
           <em>${esc(p.category)}</em><br><br>
           ${esc(p.note).replace(/\n/g,"<br>")}<br><br>
           <span class="coords">x:${Math.round(p.x)} y:${Math.round(p.y)}</span>`
        );
        markers.push(marker);
      });

      pinCountEl.textContent = pins.length.toString();
    }

    function openModal(latlng) {
      pendingLatLng = latlng;
      const x = Math.round(latlng.lng);
      const y = Math.round(latlng.lat);

      coordDisplay.textContent = `x:${x}  y:${y}`;
      pinTitle.value = "";
      pinCategory.value = "";
      pinNotes.value = "";

      modalBackdrop.style.display = "flex";
      pinTitle.focus();
    }

    function closeModal() {
      modalBackdrop.style.display = "none";
      pendingLatLng = null;
    }

    cancelPinBtn.addEventListener("click", closeModal);
    modalBackdrop.addEventListener("click", (e) => {
      if (e.target === modalBackdrop) closeModal();
    });

    addPinBtn.addEventListener("click", () => {
      if (!pendingLatLng) return;

      const x = Math.round(pendingLatLng.lng);
      const y = Math.round(pendingLatLng.lat);

      const newPin = normalizePin({
        name: pinTitle.value.trim() || "Untitled",
        category: pinCategory.value.trim() || "Uncategorized",
        note: pinNotes.value || "",
        x, y
      });

      localPins.push(newPin);
      saveLocalPins();

      pins = combinedPins();
      rebuildCategoryUI();
      renderPins();

      closeModal();
    });

    // Click map to add pin
    map.on("click", (e) => openModal(e.latlng));

    // Export pins.json (combined)
    exportBtn.addEventListener("click", () => {
      const exportPins = combinedPins();
      exportPins.sort((a,b) => (a.category.localeCompare(b.category) || a.name.localeCompare(b.name)));

      const blob = new Blob([JSON.stringify(exportPins, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "pins.json";
      document.body.appendChild(a);
      a.click();
      a.remove();

      URL.revokeObjectURL(url);
      alert("Downloaded pins.json. Upload/commit it to your GitHub repo to share with everyone.");
    });

    function readImportedFile() {
      return new Promise((resolve, reject) => {
        const file = importFile.files?.[0];
        if (!file) return reject(new Error("Choose a pins.json file first."));
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const data = JSON.parse(reader.result);
            if (!Array.isArray(data)) throw new Error("JSON must be an array.");
            resolve(data.map(normalizePin).filter(Boolean));
          } catch (err) {
            reject(err);
          }
        };
        reader.onerror = () => reject(new Error("Failed to read file."));
        reader.readAsText(file);
      });
    }

    importMergeBtn.addEventListener("click", async () => {
      try {
        const imported = await readImportedFile();
        localPins.push(...imported);
        saveLocalPins();
        pins = combinedPins();
        rebuildCategoryUI();
        renderPins();
        alert("Imported (merge) into local edits. Export + commit pins.json to share.");
      } catch (e) {
        alert(e.message || String(e));
      }
    });

    importReplaceBtn.addEventListener("click", async () => {
      try {
        const imported = await readImportedFile();
        basePins = [];
        localPins = imported;
        saveLocalPins();
        pins = combinedPins();
        rebuildCategoryUI();
        renderPins();
        alert("Imported (replace) into local state. Export + commit pins.json to share.");
      } catch (e) {
        alert(e.message || String(e));
      }
    });

    clearLocalBtn.addEventListener("click", () => {
      if (!confirm("Clear local unsaved edits on this device/browser? (Does not affect pins.json on GitHub)")) return;
      localStorage.removeItem(LOCAL_STORAGE_KEY);
      localPins = [];
      pins = combinedPins();
      rebuildCategoryUI();
      renderPins();
    });

    // ---- INIT ----
    (async function init() {
      try {
        // Verify resources (shows clear error if 404)
        await verifyResource(MAP_IMAGE_FILENAME);
        await verifyResource(PINS_FILENAME);

        // Add the image overlay
        L.imageOverlay(MAP_IMAGE_FILENAME, bounds).addTo(map);

        // Fit and constrain view
        map.fitBounds(bounds);
        map.setMaxBounds(bounds.pad(0.2));

        // Load pins
        loadLocalPins();
        await loadBasePins();
        pins = combinedPins();
        rebuildCategoryUI();
        renderPins();
      } catch (err) {
        showError(
          "Map failed to load.\n\n" +
          (err?.message || String(err)) +
          "\n\nQuick checks:\n" +
          "• Is map.jpg in the repo root and named exactly map.jpg?\n" +
          "• Is pins.json in the repo root and valid JSON?\n" +
          "• Hard refresh (Ctrl+Shift+R) after committing changes."
        );
      }
    })();

    // Cosmetic: ignore missing favicon.ico (harmless)
    // If you want, upload a favicon.ico to repo root.
  </script>
</body>
</html>
